#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#include <sha256.h>

#include <munit.h>

MunitResult million_a_test(const MunitParameter params[], void* user_data_or_fixture)
{
    const uint8_t million_a[32] = 
    {
        0xcd,0xc7,0x6e,0x5c,0x99,0x14,0xfb,0x92,
        0x81,0xa1,0xc7,0xe2,0x84,0xd7,0x3e,0x67,
        0xf1,0x80,0x9a,0x48,0xa4,0x97,0x20,0x0e,
        0x04,0x6d,0x39,0xcc,0xc7,0x11,0x2c,0xd0
    };
    uint8_t digest[32]; 
    struct sha256_t ctx;
    
    (void)params, (void)user_data_or_fixture;
    
    sha256_init(&ctx);
    for(int i=0; i<1000000; i++)
    {
        uint8_t byte = 'a';
        sha256_add(&ctx, &byte, 1); 
    }
    sha256_finalize(&ctx, digest);
    
    munit_assert_memory_equal(32, digest, million_a);    
    return MUNIT_OK;
}

MunitResult large_message_test(const MunitParameter params[], void* user_data_or_fixture)
{
    const char *msg = "abcdefghbcdefghicdefghijdefghijkefghijklfghijklmghijklmnhijklmno";
    
    const uint8_t large_message[32] = 
    {
        0x50,0xe7,0x2a,0x0e,0x26,0x44,0x2f,0xe2,
        0x55,0x2d,0xc3,0x93,0x8a,0xc5,0x86,0x58,
        0x22,0x8c,0x0c,0xbf,0xb1,0xd2,0xca,0x87,
        0x2a,0xe4,0x35,0x26,0x6f,0xcd,0x05,0x5e
    };
    uint8_t digest[32];
    struct sha256_t ctx;

    (void)params, (void)user_data_or_fixture;

    sha256_init(&ctx);
    for(uint64_t i=0; i<16777216; i++)
    {
        sha256_add(&ctx, msg, strlen(msg));
    }
    sha256_finalize(&ctx, digest);
   
    munit_assert_memory_equal(32, digest, large_message);
    return MUNIT_OK;
}

MunitResult short_message_test(const MunitParameter params[], void* user_data_or_fixture)
{
    struct 
    {
        char *data;
        uint8_t digest[32];
    } test_data[] = 
    {
        { "abc", 
          { 0xba,0x78,0x16,0xbf,0x8f,0x01,0xcf,0xea,
            0x41,0x41,0x40,0xde,0x5d,0xae,0x22,0x23,
            0xb0,0x03,0x61,0xa3,0x96,0x17,0x7a,0x9c,
            0xb4,0x10,0xff,0x61,0xf2,0x00,0x15,0xad }
        },
        { "", 
          { 0xe3,0xb0,0xc4,0x42,0x98,0xfc,0x1c,0x14,
            0x9a,0xfb,0xf4,0xc8,0x99,0x6f,0xb9,0x24,
            0x27,0xae,0x41,0xe4,0x64,0x9b,0x93,0x4c,
            0xa4,0x95,0x99,0x1b,0x78,0x52,0xb8,0x55 }
        },
        { "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq", 
          { 0x24,0x8d,0x6a,0x61,0xd2,0x06,0x38,0xb8,
            0xe5,0xc0,0x26,0x93,0x0c,0x3e,0x60,0x39,
            0xa3,0x3c,0xe4,0x59,0x64,0xff,0x21,0x67,
            0xf6,0xec,0xed,0xd4,0x19,0xdb,0x06,0xc1 }
        },
        {
           "abcdefghbcdefghicdefghijdefghijkefghijklfghijklmghijklmnhijklmnoijklmnopjklmnopqklmnopqrlmnopqrsmnopqrstnopqrstu",
           { 0xcf,0x5b,0x16,0xa7,0x78,0xaf,0x83,0x80,
             0x03,0x6c,0xe5,0x9e,0x7b,0x04,0x92,0x37,
             0x0b,0x24,0x9b,0x11,0xe8,0xf0,0x7a,0x51,
             0xaf,0xac,0x45,0x03,0x7a,0xfe,0xe9,0xd1 }
        }
    };
    uint8_t digest[32];

    (void)params, (void)user_data_or_fixture;

    for(int i=0; i<4; i++)
    {
        sha256_digest(test_data[i].data, strlen(test_data[i].data), digest);
        munit_assert_memory_equal(32, digest, test_data[i].digest);
    }
    return MUNIT_OK;
}

MunitTest sha256_tests[] =
{
    { "/Short message test", short_message_test, NULL, NULL, MUNIT_TEST_OPTION_NONE, NULL },
    { "/Million messages test", million_a_test, NULL, NULL, MUNIT_TEST_OPTION_NONE, NULL },
    { "/Large message test", large_message_test, NULL, NULL, MUNIT_TEST_OPTION_NONE, NULL },
    { NULL, NULL, NULL, NULL, MUNIT_TEST_OPTION_NONE, NULL }
};

static const MunitSuite sha256_suite = {
  "/sha256", sha256_tests, NULL, 1, MUNIT_SUITE_OPTION_NONE
};

int main(int argc, char **argv)
{
    return munit_suite_main(&sha256_suite, NULL, argc, argv);
}
